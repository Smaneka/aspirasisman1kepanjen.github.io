<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Aspirasi - OSIS/MPK SMA Negeri 1 Kepanjen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50, #4a6572);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            text-align: center;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 100%;
        }

        .admin-logo {
            width: 60px;
            height: 60px;
            background: #ff5722;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .header-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-text p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .osis-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ff5722, #ff9800);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 5px;
            font-weight: bold;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .admin-content {
            display: none;
            width: 100%;
        }

        .github-status {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9rem;
        }

        .github-status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .github-status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: #ff5722;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            background: #ff7043;
        }

        .btn-small {
            width: auto;
            padding: 8px 15px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .message-container {
            text-align: left;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 20px;
        }

        /* Scrollbar styling */
        .message-container::-webkit-scrollbar {
            width: 6px;
        }

        .message-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .message-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .message {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            animation: fadeIn 0.5s ease;
            border-left: 4px solid #ff5722;
        }

        .message.new {
            border-left: 4px solid #4caf50;
        }

        .message.urgent {
            border-left: 4px solid #f44336;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .message-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.2);
        }

        .message-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: #4caf50;
        }

        .message-status.new {
            background: #4caf50;
        }

        .message-status.read {
            background: #2196f3;
        }

        .message-status.processed {
            background: #ff9800;
        }

        .message-status.done {
            background: #9e9e9e;
        }

        .urgency-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .urgency-low {
            background: #4caf50;
        }

        .urgency-medium {
            background: #ff9800;
        }

        .urgency-high {
            background: #f44336;
        }

        .message-timestamp {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
        }

        .message-content {
            margin: 15px 0;
        }

        .message-image {
            margin-top: 15px;
            display: none;
        }

        .message-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .show-image-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .show-image-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Modal untuk gambar */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #ff5722;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .footer {
            margin-top: 40px;
            font-size: 0.9rem;
            opacity: 0.7;
            text-align: center;
            width: 100%;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s ease;
        }

        .footer-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .message-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .message-actions {
                flex-direction: column;
            }
            
            .btn-small {
                width: 100%;
                margin: 5px 0;
            }
            
            .modal-content {
                max-width: 95%;
            }
            
            .close-modal {
                top: 10px;
                right: 15px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="admin-logo">
                <i class="fas fa-lock"></i>
            </div>
            <div class="header-text">
                <h1>Admin Aspirasi <span class="osis-badge">OSIS/MPK</span></h1>
                <p>SMA Negeri 1 Kepanjen</p>
            </div>
        </div>
        
        <div id="login-section" class="login-section">
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Masukkan username admin">
            </div>
            
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Masukkan password">
            </div>
            
            <button onclick="login()"><i class="fas fa-sign-in-alt"></i> Masuk</button>
            
            <div id="login-status" class="status-message"></div>
        </div>
        
        <div id="admin-content" class="admin-content">
            <div id="github-status" class="github-status">
                <i class="fas fa-sync fa-spin"></i> Menghubungkan ke GitHub...
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="filter-category">Filter Kategori</label>
                    <select id="filter-category">
                        <option value="all">Semua Kategori</option>
                        <option value="event">Event Sekolah</option>
                        <option value="facility">Fasilitas Sekolah</option>
                        <option value="teaching">Proses Pembelajaran</option>
                        <option value="extracurricular">Ekstrakurikuler</option>
                        <option value="canteen">Kantin & Katering</option>
                        <option value="suggestion">Saran OSIS/MPK</option>
                        <option value="other">Lainnya</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-status">Filter Status</label>
                    <select id="filter-status">
                        <option value="all">Semua Status</option>
                        <option value="new">Baru</option>
                        <option value="read">Sudah Dibaca</option>
                        <option value="processed">Diproses</option>
                        <option value="done">Selesai</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-urgency">Filter Urgensi</label>
                    <select id="filter-urgency">
                        <option value="all">Semua Urgensi</option>
                        <option value="low">Biasa</option>
                        <option value="medium">Penting</option>
                        <option value="high">Sangat Penting</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-image">Filter dengan Gambar</label>
                    <select id="filter-image">
                        <option value="all">Semua Laporan</option>
                        <option value="with-image">Dengan Gambar</option>
                        <option value="without-image">Tanpa Gambar</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label style="opacity: 0;">Aksi</label>
                    <button class="btn-small btn-secondary" onclick="loadMessages()">
                        <i class="fas fa-sync-alt"></i> Segarkan
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-messages">0</div>
                    <div class="stat-label">Total Laporan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="new-messages">0</div>
                    <div class="stat-label">Laporan Baru</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="urgent-messages">0</div>
                    <div class="stat-label">Penting</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="with-image-messages">0</div>
                    <div class="stat-label">Dengan Gambar</div>
                </div>
            </div>
            
            <div id="messages-container" class="message-container">
                <p style="text-align: center; opacity: 0.7; padding: 30px;">Memuat data dari GitHub...</p>
            </div>
            
            <button class="btn-secondary" onclick="exportData()">
                <i class="fas fa-download"></i> Ekspor Data
            </button>
        </div>
        
        <!-- Modal untuk menampilkan gambar -->
        <div id="image-modal" class="modal">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-content">
                <img id="modal-image" src="" alt="Bukti Gambar">
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 OSIS/MPK SMA Negeri 1 Kepanjen. Panel Admin Aspirasi.</p>
            <div class="footer-links">
                <a href="index.html">Halaman Utama</a>
                <a href="#">Kebijakan Privasi</a>
                <a href="#">Panduan Admin</a>
            </div>
        </div>
    </div>

    <script>
        // Kredensial admin
        const ADMIN_CREDENTIALS = {
            username: "admin",
            password: "smaneka2023"
        };

        // Konfigurasi GitHub
        const GITHUB_CONFIG = {
            owner: "smaneka-aspirasi",
            repo: "data-aspirasi",
            path: "data/aspirasi.json",
            branch: "main"
        };

        // Token akses GitHub (dalam produksi seharusnya menggunakan backend yang aman)
        const GITHUB_TOKEN = "github_pat_11AEXAMPLEEXAMPLEEXAMPLEEXAMPLExxx"; // Ganti dengan token Anda

        // Variabel global
        let messagesData = [];
        let isGitHubConnected = false;

        // Fungsi untuk login
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('login-status');
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                statusDiv.innerHTML = `
                    <div class="success">
                        <i class="fas fa-check-circle"></i> Login berhasil!
                    </div>
                `;
                
                // Sembunyikan form login, tampilkan konten admin
                setTimeout(() => {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    checkGitHubConnection();
                }, 1000);
            } else {
                statusDiv.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i> Username atau password salah!
                    </div>
                `;
            }
        }

        // Fungsi untuk memeriksa koneksi GitHub
        async function checkGitHubConnection() {
            const statusDiv = document.getElementById('github-status');
            
            try {
                // Coba akses file data di GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${GITHUB_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    // Berhasil terhubung ke GitHub
                    const data = await response.json();
                    const content = atob(data.content);
                    messagesData = JSON.parse(content);
                    
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Terhubung ke GitHub. Data berhasil dimuat.`;
                    statusDiv.className = 'github-status success';
                    isGitHubConnected = true;
                    
                    loadMessages();
                    updateStats();
                } else {
                    throw new Error('Tidak dapat mengakses repository');
                }
            } catch (error) {
                console.error('Koneksi GitHub gagal:', error);
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Gagal terhubung ke GitHub: ${error.message}`;
                statusDiv.className = 'github-status error';
                isGitHubConnected = false;
                
                // Muat data dari localStorage sebagai fallback
                const localData = localStorage.getItem('aspirasiData');
                messagesData = localData ? JSON.parse(localData) : [];
                
                if (messagesData.length > 0) {
                    loadMessages();
                    updateStats();
                } else {
                    document.getElementById('messages-container').innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 30px;">Tidak ada data yang ditemukan</p>';
                }
            }
        }

        // Fungsi untuk memuat pesan dari GitHub
        async function loadMessages() {
            // Jika terhubung ke GitHub, muat data terbaru
            if (isGitHubConnected) {
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${GITHUB_TOKEN}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const content = atob(data.content);
                        messagesData = JSON.parse(content);
                    }
                } catch (error) {
                    console.error('Error memuat data dari GitHub:', error);
                }
            }
            
            // Terapkan filter
            applyFilters();
        }

        // Fungsi untuk menerapkan filter
        function applyFilters() {
            const categoryFilter = document.getElementById('filter-category').value;
            const statusFilter = document.getElementById('filter-status').value;
            const urgencyFilter = document.getElementById('filter-urgency').value;
            const imageFilter = document.getElementById('filter-image').value;
            const container = document.getElementById('messages-container');
            
            if (messagesData.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 30px;">Tidak ada laporan yang ditemukan</p>';
                updateStats();
                return;
            }
            
            // Filter messages
            let filteredMessages = [...messagesData];
            
            if (categoryFilter !== 'all') {
                filteredMessages = filteredMessages.filter(msg => msg.category === categoryFilter);
            }
            
            if (statusFilter !== 'all') {
                filteredMessages = filteredMessages.filter(msg => msg.status === statusFilter);
            }
            
            if (urgencyFilter !== 'all') {
                filteredMessages = filteredMessages.filter(msg => msg.urgency === urgencyFilter);
            }
            
            if (imageFilter !== 'all') {
                if (imageFilter === 'with-image') {
                    filteredMessages = filteredMessages.filter(msg => msg.image);
                } else if (imageFilter === 'without-image') {
                    filteredMessages = filteredMessages.filter(msg => !msg.image);
                }
            }
            
            // Urutkan dari yang terbaru
            filteredMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (filteredMessages.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 30px;">Tidak ada laporan dengan filter yang dipilih</p>';
                updateStats();
                return;
            }
            
            // Tampilkan pesan
            displayMessages(filteredMessages);
            updateStats();
        }

        // Fungsi untuk menampilkan pesan
        function displayMessages(messages) {
            const container = document.getElementById('messages-container');
            
            const categoryNames = {
                'event': 'Event Sekolah',
                'facility': 'Fasilitas Sekolah',
                'teaching': 'Pembelajaran',
                'extracurricular': 'Ekstrakurikuler',
                'canteen': 'Kantin & Katering',
                'suggestion': 'Saran OSIS/MPK',
                'other': 'Lainnya'
            };
            
            const statusLabels = {
                'new': 'Baru',
                'read': 'Dibaca',
                'processed': 'Diproses',
                'done': 'Selesai'
            };
            
            const urgencyLabels = {
                'low': 'Biasa',
                'medium': 'Penting',
                'high': 'Sangat Penting'
            };
            
            let html = '';
            
            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const timeString = date.toLocaleString('id-ID');
                const hasImage = msg.image ? true : false;
                
                html += `
                    <div class="message ${msg.status === 'new' ? 'new' : ''} ${msg.urgency === 'high' ? 'urgent' : ''}">
                        <div class="message-header">
                            <span class="message-category">${categoryNames[msg.category]}</span>
                            <div>
                                <span class="message-status ${msg.status}">${statusLabels[msg.status]}</span>
                                <span class="urgency-badge urgency-${msg.urgency}">${urgencyLabels[msg.urgency]}</span>
                            </div>
                        </div>
                        <div class="message-content">
                            <p>${msg.text}</p>
                            ${hasImage ? `
                                <div class="message-image" id="image-${msg.id}">
                                    <img src="${msg.image}" alt="Bukti Gambar">
                                </div>
                                <button class="show-image-btn" onclick="toggleImage(${msg.id})">
                                    <i class="fas fa-image"></i> Lihat Bukti Gambar
                                </button>
                                <button class="show-image-btn" onclick="openModal('${msg.image}')">
                                    <i class="fas fa-expand"></i> Perbesar Gambar
                                </button>
                            ` : ''}
                        </div>
                        <div class="message-timestamp">Dikirim: ${timeString}</div>
                        <div class="message-actions">
                            <button class="btn-small" onclick="markAsRead(${msg.id})">
                                <i class="fas fa-check"></i> Tandai Dibaca
                            </button>
                            <button class="btn-small" onclick="markAsProcessed(${msg.id})">
                                <i class="fas fa-cog"></i> Sedang Diproses
                            </button>
                            <button class="btn-small" onclick="markAsDone(${msg.id})">
                                <i class="fas fa-flag"></i> Tandai Selesai
                            </button>
                            <button class="btn-small btn-secondary" onclick="deleteMessage(${msg.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Fungsi untuk memperbarui statistik
        function updateStats() {
            // Total messages
            document.getElementById('total-messages').textContent = messagesData.length;
            
            // New messages
            const newMessages = messagesData.filter(msg => msg.status === 'new').length;
            document.getElementById('new-messages').textContent = newMessages;
            
            // Urgent messages
            const urgentMessages = messagesData.filter(msg => msg.urgency === 'high').length;
            document.getElementById('urgent-messages').textContent = urgentMessages;
            
            // Messages with images
            const withImageMessages = messagesData.filter(msg => msg.image).length;
            document.getElementById('with-image-messages').textContent = withImageMessages;
        }

        // Fungsi untuk menyimpan data ke GitHub
        async function saveDataToGitHub() {
            if (!isGitHubConnected) {
                // Simpan ke localStorage jika GitHub tidak tersambung
                localStorage.setItem('aspirasiData', JSON.stringify(messagesData));
                return false;
            }
            
            try {
                // Dapatkan SHA file yang ada
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${GITHUB_TOKEN}`
                    }
                });
                
                let sha = null;
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                }
                
                // Konversi data ke base64
                const content = btoa(JSON.stringify(messagesData, null, 2));
                
                // Buat payload untuk update
                const payload = {
                    message: `Update data aspirasi - ${new Date().toLocaleString('id-ID')}`,
                    content: content,
                    sha: sha,
                    branch: GITHUB_CONFIG.branch
                };
                
                // Kirim update ke GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    return true;
                } else {
                    throw new Error('Gagal menyimpan ke GitHub');
                }
            } catch (error) {
                console.error('Error menyimpan ke GitHub:', error);
                
                // Fallback ke localStorage
                localStorage.setItem('aspirasiData', JSON.stringify(messagesData));
                
                return false;
            }
        }

        // Fungsi untuk menampilkan/menyembunyikan gambar
        function toggleImage(messageId) {
            const imageElement = document.getElementById(`image-${messageId}`);
            if (imageElement.style.display === 'block') {
                imageElement.style.display = 'none';
            } else {
                imageElement.style.display = 'block';
            }
        }

        // Fungsi untuk membuka modal gambar
        function openModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            modalImage.src = imageSrc;
            modal.classList.add('show');
            
            // Tambahkan event listener untuk menutup modal saat mengklik di luar gambar
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // Fungsi untuk menutup modal
        function closeModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('show');
        }

        // Fungsi untuk menandai sebagai dibaca
        async function markAsRead(id) {
            await updateMessageStatus(id, 'read');
        }

        // Fungsi untuk menandai sebagai diproses
        async function markAsProcessed(id) {
            await updateMessageStatus(id, 'processed');
        }

        // Fungsi untuk menandai sebagai selesai
        async function markAsDone(id) {
            await updateMessageStatus(id, 'done');
        }

        // Fungsi untuk memperbarui status pesan
        async function updateMessageStatus(id, status) {
            const messageIndex = messagesData.findIndex(msg => msg.id === id);
            
            if (messageIndex !== -1) {
                messagesData[messageIndex].status = status;
                
                // Simpan perubahan
                const saved = await saveDataToGitHub();
                
                if (saved) {
                    loadMessages();
                } else {
                    alert('Perubahan disimpan secara lokal. GitHub tidak tersambung.');
                    loadMessages();
                }
            }
        }

        // Fungsi untuk menghapus pesan
        async function deleteMessage(id) {
            if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                messagesData = messagesData.filter(msg => msg.id !== id);
                
                // Simpan perubahan
                const saved = await saveDataToGitHub();
                
                if (saved) {
                    loadMessages();
                } else {
                    alert('Perubahan disimpan secara lokal. GitHub tidak tersambung.');
                    loadMessages();
                }
            }
        }

        // Fungsi untuk ekspor data
        function exportData() {
            const dataStr = JSON.stringify(messagesData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `laporan_aspirasi_smaneka_${new Date().toLocaleDateString('id-ID')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Event listeners untuk filter
        document.getElementById('filter-category').addEventListener('change', applyFilters);
        document.getElementById('filter-status').addEventListener('change', applyFilters);
        document.getElementById('filter-urgency').addEventListener('change', applyFilters);
        document.getElementById('filter-image').addEventListener('change', applyFilters);

        // Tambahkan event listener untuk menutup modal dengan tombol ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            // Cek apakah admin sudah login
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            
            // Inisialisasi data di localStorage
            if (!localStorage.getItem('aspirasiData')) {
                localStorage.setItem('aspirasiData', JSON.stringify([]));
            }
        });
    </script>
</body>
</html>